# データの加工 {#handling}

以下の記述はすでに`tidyverse`パッケージを読み込んでおり、また読み込んだデータを`piaac`というデータフレームに入れていることを前提とします。データフレームの名前は`piaac`である必要はありません。以下のようなコードを実行していると思います。

```{r, eval = FALSE}
library(tidyverse)
piaac <- read_csv("data/piaac.csv")
```

## サンプルの限定

関心によっては、若年の人だけ分析したいとか、高齢の人だけ分析したいとか、女性（男性）だけ分析したいというときがある。それ以外にも、使う変数にNAが含まれているケースをあらかじめ除外するということはふつうにある。このようなときには、`filter()`を使う。

性別（gender）が男性のケースのみを抽出し、抽出したデータに新しい名前（piaac_male）をつける。

```{r}
piaac_male <- piaac %>% 
  filter(gender == "男性")
```

年齢が25歳以上34歳以下のケースのみを抽出し、抽出したデータに新しい名前（piaac_young）をつける。

```{r}
piaac_young <- piaac %>% 
  filter(age >= 25 & age <= 34)
```

条件記号の意味は次の通り。

+----------+------------+-------------------------+--------------------------------------+
| 条件記号 | 意味       | コード例                | コード例の意味                       |
+==========+============+=========================+======================================+
| `==`     | 等しい     | `age == 25`             | 年齢が25に等しい                     |
+----------+------------+-------------------------+--------------------------------------+
| `!=`     | ではない   | `age != 25`             | 年齢が25ではない                     |
+----------+------------+-------------------------+--------------------------------------+
| `>`      | より大きい | `age > 25`              | 年齢が25より大きい                   |
+----------+------------+-------------------------+--------------------------------------+
| `<`      | より小さい | `age < 25`              | 年齢が25より小さい                   |
+----------+------------+-------------------------+--------------------------------------+
| `>=`     | 以上       | `age >= 25`             | 年齢が25以上（25を含む）             |
+----------+------------+-------------------------+--------------------------------------+
| `<=`     | 以下       | `age <= 25`             | 年齢が25以下（25を含む）             |
+----------+------------+-------------------------+--------------------------------------+
| `&`      | かつ       | `age >= 25 & age <= 54` | 年齢が25以上54以下                   |
+----------+------------+-------------------------+--------------------------------------+
| `|`      | または     | `age < 35 | age > 54`   | 年齢が35より小さいまたは54より大きい |
+----------+------------+-------------------------+--------------------------------------+

## 変数の作成

### 新たな変数を作成：mutate()

データ操作の基本は、すでにある変数を書き換えたりして、自分の関心に即した新しい変数を作ることである。このときに使用するのが`mutate()`。

例1：1週間の労働時間を尋ねた変数workhourを5で割って、平日1日あたりの労働時間を計算する。

```{r}
piaac <- piaac %>% 
  mutate(workhour_day = workhour / 5)
```

例2：1ずつ増える変数を作成する（例えば新しい個人idなどを振ったりしたいときに使う）

```{r}
piaac <- piaac %>% 
  mutate(id = 1:n())
```

`n()` はデータフレーム内の行数を返す関数。以上の例で作成した変数は次のようになっている：

```{r}
piaac %>% 
  select(workhour, workhour_day, id) %>% # select()についてはこのあと解説があります
  head()
```

### 条件の指定：if_else()

実際に`mutate()`で既存の変数の値を書き換えたりする場合には、カテゴリをまとめたり、複数の変数を組み合わせて新しい変数を作成したりすることが多い。そこでよく使う関数が`if_else()`、`case_when()`、`factor()`の3つだ。

`if_else()`は、条件を指定し、その条件に合う場合と合わない場合の値を返す関数。`if_else(条件, 条件に合う場合の値, 条件に合わない場合の値)`、というふうに使う。

```{r}
piaac <- piaac %>% 
  mutate(univ = if_else(educ == "大学大学院", "大卒", "非大卒"))

piaac %>% 
  with(table(educ, univ)) #正しくできたか確認
```

### 複数条件の指定：case_when()

たとえば、年齢を10歳区切りにして比較をしたいとする。このときには、複数条件を指定して値を書き換えるコマンドである、`case_when()`をつかうとよい。

```{r}
piaac %>% 
  select(age) %>% 
  summary() #年齢の分布を確認
```

```{r}
piaac <- piaac %>% 
  mutate(agegroup = case_when(
    25 <= age & age <= 34 ~ "25-34歳",
    35 <= age & age <= 44 ~ "35-44歳",
    45 <= age & age <= 54 ~ "45-54歳",
    55 <= age & age <= 64 ~ "55-64歳"
    ))
```

ちゃんとできたかを確認。

```{r}
piaac %>% 
  with(table(age, agegroup))
```

### カテゴリ変数へ変換：factor()

職場（事業所単位）で何人の従業員が働いているかを尋ねた質問項目（estsize）があるとする。

| 選択肢     | 調査票の番号 |
|------------|--------------|
| 1-10人     | 1            |
| 11-50人    | 2            |
| 51-250人   | 3            |
| 251-1000人 | 4            |
| 1001人以上 | 5            |

```{r}
piaac %>% with(table(estsize))
```

この数値だけでは、何番が何を指しているのかよくわからない。そこで、この変数をfactorに変換した変数estsize_fctを作成する。

```{r}
piaac <- piaac %>% 
  mutate(estsize_fct = factor(estsize,
                              levels = 1:5,
                              labels = c("1-10人", "11-50人", "51-250人", "251-1000人", "1001人以上")))
```

結果を確認：

```{r}
piaac %>% with(table(estsize_fct))
```

新しくカテゴリ変数を作るとき、カテゴリの順序が意図していたものとは違う順序になってしまうことがある。これは、文字列の場合はアルファベット順、日本語の場合はshift-jis順で並んでしまうことによる。たとえば、1週間の労働時間（workhour）に関する変数をもとに、労働時間の長さ別に分けたカテゴリ変数を作成したいと思ったとする。`case_when()` を使って作成すると、意図していた順序とは違ったバラバラの順番になってしまう。

```{r}
piaac <- piaac %>% 
  mutate(workhour_fct = case_when(
    workhour < 35 ~ "短時間",
    workhour >= 35 & workhour <= 49 ~ "通常",
    workhour >= 50 & workhour <= 59 ~ "準長時間",
    workhour >= 60 ~ "長時間"
  ))

piaac %>% with(table(workhour_fct))
```

このような場合には、いったん数値の変数を挟んでから`factor()` を使って変数を作成することで、順番がばらばらになってしまうのを防ぐことができる。

```{r}
piaac <- piaac %>% 
  mutate(workhour_fct = case_when(
    workhour < 35 ~ 1,
    workhour >= 35 & workhour <= 49 ~ 2,
    workhour >= 50 & workhour <= 59 ~ 3,
    workhour >= 60 ~ 4
  )) %>% 
  mutate(workhour_fct = factor(workhour_fct,
                               levels = 1:4,
                               labels = c("短時間", "通常", "準長時間", "長時間")))

piaac %>% with(table(workhour_fct)) 
```

### 必要な列のみ抽出：select()

データから特定の変数だけ抜き出したり、あるいは特定の変数だけ落としたりしたい場合がある。こういうときには、`select()`を使う。

```{r}
piaac_1 <- piaac %>% 
  select(gender, age, educ) #gender, age, educの列を抽出
```

```{r}
piaac_2 <- piaac %>% 
  select(-gender, -age, -educ) #gender, age, educ「以外」の列を抽出
```

## 変数の操作化についてのtips

### カテゴリをまとめる

たとえば、親の職業（階級）によって、対象者の学歴がどの程度異なるのかを知りたいとする。このとき、学歴を「中学」「高校」「短大高専」「大学大学院」という4つのカテゴリで定義しているとする。この場合には、たとえば「大学大学院」を1、それ以外を0とすることで、大学以上か大学未満か、という2値のカテゴリにする。

一つひとつのカテゴリに該当する人数が少ないときや、議論を単純化したいときに有効な方法といえる。

### 均等な順序を仮定して連続変数とする

ある程度均等な順序があると仮定できるならば、数値として扱うことを考えてみるとよい。JGSSでは、「現在の仕事にどの程度満足していますか」という質問（ST5JOB）で、仕事への満足度が尋ねられている。選択肢は「満足している」「どちらかといえば満足している」「どちらともいえない」「どちらかといえば不満である」「不満である」という5つから1つを選択する形式である（わからないや無回答もあるが（後述）、ここでは省略する）。このようなときには、以下のように数値を割り当てることで、値が高いほど満足していることを表す連続変数に見立てることができる。もちろん、選択肢間の間隔がどれも同じ1であるというのはあくまで仮定であり本当は違うかもしれないということには注意が必要だが、解釈はわかりやすくなるというメリットがある。

| 選択肢         | 調査票上の番号 | 数値化例 |
|----------------|----------------|----------|
| 満足している     | 1              | 5        |
| どちらかといえば満足している           | 2              | 4        |
| どちらでもない | 3              | 3        |
| どちらかといえば不満である           | 4              | 2        |
| 不満である     | 5              | 1        |

```{r, echo = FALSE}
ST5JOB <- c(1, 5, 4, 2, 1, 3)
jgss <- tibble(ST5JOB)
```

```{r}
jgss #元のデータ（架空例）
```

以下のようにして値を変えた変数を作成する。

```{r}
jgss <- jgss %>% 
  mutate(jobsatis = 6 - ST5JOB)

jgss
```


なお、こうした扱いが認められるかどうかは扱う変数によって異なるので、先行研究での定義を参考にするとよい。たとえば今回のような仕事への満足度についてはおおむねこのような処理は認められているが、「中学」に1、「高校」に2、「短大高専」に3、「大学大学院」に4を振る、というような処理はあまり認められていない。しかしながら、受けた教育年数として、「中学」に9、「高校」に12、「短大高専」に14、「大学」に16、「大学院」に18（など）といった値を振ることはある程度認められている。このあたりは先行研究の操作化を参考にしつつ、最終的には自分たちの関心によって決めるとよいだろう。


### 無回答、非該当、「わからない」などをNAに

JGSSでは「夫は外で働き、妻は家庭を守るべきだ」という意見に対して賛成か反対かを4つの選択肢を設けて尋ねている。ただし、この質問に（何らかの理由で）回答していない者もおり、そのような場合には9という値が便宜的に振られている。

この質問に対する回答を連続値とみなして集計したりしたいとする。このような場合、無回答の9という値は計算から除外したいので、9という値ではなくNAとしたい。

```{r, echo = FALSE}
Q4WWHHX <- c(1, 9, 4, 3, 2, 1)
jgss <- tibble(Q4WWHHX)
```

```{r}
jgss #元のデータ（架空例）
```

以下のようにして9をNAに置き換えた変数を作成する。

```{r}
jgss <- jgss %>% 
  mutate(genderrole = if_else(Q4WWHHX == 9, NA_real_, Q4WWHHX))  # 9をNAに置換

jgss #変換後のデータ
```

調査によってはこのように無回答やあるいは「わからない」という選択肢に対して便宜的に99という数字が振られていたり、非該当（たとえば結婚している人に対してのみ尋ねる質問の場合、結婚していない人はその質問に回答しない。このような場合には、回答対象ではないという意味で、非該当とされる）のケースに対して便宜的に88といったような数字が振られていることがある。このような場合にも同じようにNAに変換する。

この作業を忘れて平均値などを計算するととんでもない間違いを犯してしまうことになるため、忘れないようにしっかりチェックしておきたい。実際、[ある査読付き雑誌に掲載された論文が、売上高がわからないケースに対して付されていた88,888,888,888という値をNAにすることなく分析していたのではないか（実際、それをNAにすると分析の結果はまったく違うものになる）という指摘](https://doi.org/10.1177/0003122417714422)がなされ、大きな話題を読んだことがある。

用いる変数については平均値だけではなく、分布や実際の値、調査票の文言などをきちんとチェックしておき、くれぐれもこのようなミスが起こらないようにしたい。

### カテゴリ変数の区間の中点をとって連続変数とする

なんらかの区間をとって尋ねられている場合、その区間の中点をとって、連続変数とみなす。たとえば、日本家族社会学会が行っている2008年全国家族調査（NFRJ08）では、「あなたご自身...は、次にあげる...家事を現在どのくらいの頻度で行っていますか」という質問項目で、たとえば「食事の用意」について、以下のような選択肢で家事頻度を尋ねている。

| 選択肢               | 調査票上の番号 | 数値化例 |
|----------------------|----------------|----------|
| ほぼ毎日（週6〜7回） | 1              | 6.5      |
| 1週間に4〜5回        | 2              | 4.5      |
| 1週間に2〜3回        | 3              | 2.5      |
| 1週間に1回くらい     | 4              | 1        |
| ほとんど行わない     | 5              | 0        |

このような場合、週6〜7回という区間の中点をとって6.5、週4〜5回という区間の中点をとって4.5、、etcとすることで、1週間当たりの家事頻度を表す連続変数と見立てることができる。

こうした扱いがどの程度許容されるかについては、先行研究での定義を参照するとよい。

年収などもこうした区間で扱われることがあるが、この場合は中点を定義できない選択肢が設けられていることがある（例：2050万円以上）。こうした場合の扱いについては別途書く（工事中）
