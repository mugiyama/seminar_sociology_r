# 回帰分析の活用 {#regression_advanced}

以下の記述はすでに`tidyverse`パッケージを読み込んでおり、また読み込んだデータを`piaac`というデータフレームに入れていることを前提とします。データフレームの名前は`piaac`である必要はありません。以下のようなコードを実行しています。

```{r, eval = FALSE}
library(tidyverse)
piaac <- read_csv("data/piaac.csv")
```

また、Macで`ggplot2`パッケージを使用し、グラフ中に日本語を使用する場合には、`library(tidyverse)`または`library(ggplot2)`を実行したうえで、たとえば以下のようなコードをあらかじめ実行しておく必要があります。

```{r, eval = FALSE}
theme_set(theme_grey(base_family = "HiraginoSans-W3"))
```

この資料で使用しているグラフについては以下のようにthemeを設定しています。

```{r, eval = FALSE}
theme_set(theme_bw(
  base_family = "HiraginoSans-W3",
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

Windowsユーザの方は上記コードから`base_family = `の行を除いたこちらのコードで同じような雰囲気になります：

```{r, eval = FALSE}
theme_set(theme_bw(
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

## 重回帰分析

先の単回帰分析では、年齢、性別、あるいは学歴によって賃金が異なっていることをみた。これら3つの変数を同時に考慮することで、賃金の分散をよりよく説明できるモデルを作ることができないだろうか？このようなときに役に立つのが、重回帰分析である。

今推定したい式は次のように書くことができる。

$$
y = \beta_0 + \beta_1年齢 + \beta_2女性 + \beta_3高校卒 + \beta_4短大高専卒 + \beta_5大学大学院卒
$$

$\beta_1$が年齢の係数、$\beta_2$が（男性と比較したときの）女性の係数、$\beta_3, \beta_4, \beta_5$が（中学卒と比較したときの）高校卒、短大高専卒、大学大学院卒の係数を、それぞれ表す。各係数は、**他の変数を一定として**（**統制 control**して、ともいう）、当該変数が1単位高いと$y$がどれだけ高いのか、という独立の影響力を測っていることになる。

単回帰分析のときと同じように、`lm()`関数を使って推定することができる。

```{r}
reg_res <- lm(data = piaac, wage ~ age + gender + educ)
summary(reg_res)
```

それぞれ係数、標準誤差、p値のみかたはいずれも前回と同じである。

一般に、重回帰分析の式は次のように書ける。

$$
y = \beta_0 + \beta_1x_1 + \beta_2x_2 + \cdots + \beta_kx_k
$$

係数$\beta_1$は、他の変数$x_2, \cdots, x_k$を一定としたうえで、$x_1$が1単位高いと$y$がどれだけ高いのかを示す。

重回帰分析の係数はやはり最小二乗法によって推定される。

## 交絡要因の統制

では実際、重回帰分析はどのようなことを知りたいときに使うのだろうか。たとえば、高い学校段階を終えたこと（学歴）がどれくらい賃金を高めるのかを知りたいというモチベーションを持っているとする。もっともシンプルな方法が、前回みたように（単）回帰分析で学歴ごとに賃金を比較するという方法だ。

しかしこの方法では、学歴の効果を知るには不十分かもしれない。というのも、データには25歳から64歳まで幅広い年齢の対象者が含まれており、また男性も女性も含まれている。学歴別に書いた次の散布図を見てみよう：

```{r}
piaac %>% 
  ggplot(aes(x = age, y = wage, color = gender)) + 
  geom_point(shape = 1) +
  facet_wrap(~educ) + 
  labs(color = "")
```

高学歴化が進んだ影響で、中学卒の人には年齢の高い（古い年の生まれの）人が多く、短大高専や大学卒の人には年齢の低い人が多い。年齢が高くなるにつれて賃金が高くなるという傾向があるから、たんに学歴ごとに平均値をとったときには、このような年齢分布の違いは、中学卒の見かけの賃金を高く、短大高専卒や大学卒の見かけの賃金を低く見せるだろう。

性別も重要だ。たとえば短大高専卒では男性よりも女性が多く、大学卒では女性よりも男性が多い。男性のほうが（さまざまな理由によって）女性よりも賃金高い傾向があるから、このような性別分布の違いは、短大高専卒の見かけの賃金を低く、大学卒の見かけの賃金を高く見せるだろう。

以上のような分布の違いを**一定としたうえで**学歴と賃金の関係をみることができたなら、「学歴はどの程度賃金を高める効果を持つのか」という問いの答えに近づくことができる。重回帰分析は、こうしたモチベーションに答えるための方法だ。

このときのモチベーションを図にすると、次のようなかたちになる。

```{r, echo=FALSE}
dag_1 <- dagitty("dag{X -> Y; Z -> X; Z -> Y}")
coordinates(dag_1) <- list(x = c(X = 0, Z = 1, Y = 2),
                           y = c(X = 0, Z = 1, Y = 0))
dag_1 %>% 
  tidy_dagitty() %>% 
  ggdag() + 
  theme_dag()
```

Xを学歴、Yを賃金、Zを性別や年齢と考えよう。知りたいのは学歴が賃金に与える効果（X -> Y）だが、その背後にはXにもYにも影響する要因Z（Z -> X、Z -> Y）が存在する。そのため、学歴が賃金に与える効果をみたいのならば、Zを一定とする必要がある。このように、XとYの両者に影響する要因を**交絡要因 confounder**とよぶ。

複数の変数を使うときの回帰分析では、関心のある変数xと、統制したい変数zというふうに別々の役割があるということが多い。

## 結果の比較と解釈

性別や年齢といった交絡要因を考慮しない単回帰分析と、重回帰分析を比較してみよう。この例のように、回帰分析の表を作るとき、カテゴリ変数については比較対象（参照カテゴリ）が何かを書くと、わかりやすいだろう。

```{r}
reg_res1 <- lm(data = piaac, wage ~ educ)
reg_res2 <- lm(data = piaac, wage ~ age + gender + educ)

modelsummary(list(reg_res1, reg_res2),
         stars = TRUE, 
         coef_rename = c("(Intercept)" = "切片",
                         "age" = "年齢",
                         "gender男性" = "男性（vs. 女性）",
                         "educ高校" = "高校（vs. 中学）",
                         "educ短大高専" = "短大高専（vs. 中学）",
                         "educ大学大学院" = "大学大学院（vs. 中学）"
                         ), 
         gof_omit = "R2 Adj.|AIC|BIC|Log.Lik.|F")
```

```{r, echo = FALSE}
reg_res2_tidy <- tidy(reg_res2) %>% 
  mutate(estimate = round(estimate, digits = 0))
```

Model 1とModel 2とでは、学歴の係数が違っていることがわかる。Model 1では、中学卒の人とくらべて高校卒では`r reg_res2_tidy$estimate[4]`円、短大高専卒では`r reg_res2_tidy$estimate[5]`円、大学大学院卒では`r reg_res2_tidy$estimate[6]`円、賃金が高いことがわかる。

一方で性別と年齢を一定としたModel 2では、学歴の係数は大きく異なっている。とくに、短大高専卒の係数に注目してみよう。Model 1と比べるとその係数はかなり大きくなっている。先にみたように、高学歴の人には（平均的にみて賃金が低い）若い人が多く、また短大高専卒には（平均的にみて賃金が低い）女性が多かった。これらの影響のために、中学卒との見かけの賃金の差（Model 1）は小さめに見えていた。しかし、これら性別と年齢の影響を除く（一定とする）ことによって、短大高専を卒業することによる賃金上昇をより正確に捉えることができるようになったといえる。その他の学歴についても、Model 1と比べると、**学歴が賃金を高める効果**の推定に近づいているといえる。

もちろん、性別や年齢だけではなくほかにもさまざまな要因が絡んでくるから、これだけでは学歴が賃金に与える効果を完璧に正しく推定しているというわけではない。しかし、このように要因を統制することで、学歴が賃金を高める効果の推定値に近づいていくことができる。

## 媒介分析／要因分解

### モチベーション

女性は男性と比べて賃金が低い（男女間賃金格差）。たとえばその原因には、(1) 女性が男性よりも教育水準（学歴）が低い、(2) 女性が男性よりもスキルレベル（ここでは、PIAACの試験で測定された数的思考力のスコアとする）が低い、ということがありえるだろう。このような原因を調べるというときにも、重回帰分析を活用することができる。

性別をX、賃金をY、学歴およびスキルレベルをMとすると、ここでのアイデアは次のような図に表すことができる。

```{r, echo=FALSE}
dag_1 <- dagitty("dag{X -> Y; X -> M; M -> Y}")
coordinates(dag_1) <- list(x = c(X = 0, M = 1, Y = 2),
                           y = c(X = 0, M = 1, Y = 0))
dag_1 %>% 
  tidy_dagitty() %>% 
  ggdag() + 
  theme_dag()
```

性別が賃金に与える効果は、(1) 女性の教育水準やスキルレベルが低く、したがって賃金も低い（X -> M -> Y）という部分と、(2) 教育水準やスキルレベルを一定としてもなお女性のほうが賃金が低い（X -> Y | M）という部分とに分けることができる。このようにして、XとYの中間にある要因を考えることでグループ間の差や独立変数の効果を分けていくことを指して、**媒介分析 mediation analysis**や**要因分解decomposition**などという。

```{r}
piaac <- piaac %>% 
  mutate(female_d = if_else(gender == "女性", 1, 0))

reg_res1 <- lm(data = piaac, wage ~ female_d)
reg_res2 <- lm(data = piaac, wage ~ female_d + educ)
reg_res3 <- lm(data = piaac, wage ~ female_d + educ + numeracy)

modelsummary(list(reg_res1, reg_res2, reg_res3),
                  stars = TRUE, 
         coef_rename = c("(Intercept)" = "切片",
                         "female_d" = "女性（vs. 男性）",
                         "educ高校" = "高校（vs. 中学）",
                         "educ短大高専" = "短大高専（vs. 中学）",
                         "educ大学大学院" = "大学大学院（vs. 中学）",
                         "numeracy" = "数的思考力"), 
         gof_omit = "R2 Adj.|AIC|BIC|Log.Lik.|F")
```


```{r, echo = FALSE}
reg_res1_tidy <- tidy(reg_res1) %>% 
  mutate(estimate = round(estimate, digits = 0))
reg_res2_tidy <- tidy(reg_res2) %>% 
  mutate(estimate = round(estimate, digits = 0))
reg_res3_tidy <- tidy(reg_res3) %>% 
  mutate(estimate = round(estimate, digits = 0))
```

Model 1では女性は男性に比して`r reg_res1_tidy$estimate[2]`円賃金が低いということがわかる。

Model 2では、学歴を追加している。学歴の係数は正であり、学歴が高いほど、賃金は高い傾向があるといえる。学歴を一定とすると、女性の係数は`r reg_res2_tidy$estimate[2]`となり、これはModel 1の女性の係数よりも小さい。すなわち、女性の賃金が低いことの一部は、学歴が低いために賃金が低い、ということによって生じているということがわかる。

Model 3ではさらに数的思考力を追加している。数的思考力の係数は正であり、数的思考力のスコアが高いほど、賃金が高い傾向があるといえる。学歴と数的思考力を一定とすると、女性の係数は`r reg_res3_tidy$estimate[2]`となり、やはりModel 1の女性の係数よりも小さい。すなわち、女性の賃金が低いことの一部は、学歴が低いために賃金が低いこと、数的思考力スコアが低いために賃金が低いことによって生じているということがわかる。しかしながら、これらの個人属性を一定としてもなお、男女間には非常に大きな賃金格差が存在しているといえる。

### （発展）係数変化の可視化

女性の係数を図にして表すことによって、それぞれの要因を追加したときの係数の違いを視覚的に把握しやすくなる。`broom`パッケージを使うことで、回帰分析の推定結果から係数や信頼区間に関する値を抽出し、それを使って図を作成することができる。

```{r, eval = FALSE}
install.packages("broom") #未インストールの場合のみ
library(broom)
```

```{r}
m1 <- tidy(reg_res1, conf.int = TRUE) %>% 
  mutate(model = "Model 1")
m2 <- tidy(reg_res2, conf.int = TRUE) %>% 
  mutate(model = "Model 2")
m3 <- tidy(reg_res3, conf.int = TRUE) %>% 
  mutate(model = "Model 3")

m1 %>% 
  bind_rows(m2, m3) %>% 
  filter(term == "female_d") %>% 
  ggplot(aes(x = model, y = estimate)) + 
  geom_point() + 
  geom_pointrange(aes(ymax = conf.high, ymin = conf.low)) + 
  geom_text(aes(label = round(estimate, digit = 1)), hjust = 1.2) + 
  ylim(-1000, 0) + 
  geom_hline(yintercept = 0, lty = 2) + 
  labs(x = "", y = "対数賃金の男女差", caption = "注：Model 1は性別のみ、Model 2は学歴を統制、Model 3はさらに数的思考力を統制。")
```


## 重回帰分析の実際

実際の論文では、交絡要因の統制と媒介分析の両方を考慮しながら分析されることが多い。すなわち、次のような図になる。

```{r, echo=FALSE}
dag_1 <- dagitty("dag{X -> Y; Z -> X; Z -> Y; X -> M; M -> Y}")
coordinates(dag_1) <- list(x = c(X = 0, Z = 1, M = 1, Y = 2),
                           y = c(X = 0, Z = 1, M = -1, Y = 0))
dag_1 %>% 
  tidy_dagitty() %>% 
  ggdag() + 
  theme_dag()
```

たとえば、学歴が高いと賃金が高い（X -> Y）のはなぜなのか知りたいとする。その原因の1つとして、学歴が高いとよりスキルレベルが高い（賃金の高い）職業につくことができるから（X -> M -> Y）、ということが考えられる。実際、学歴別に職業（ISCO 1-digit, 軍隊は除く）の分布を比べてみると、学歴が高いほど管理職や専門職といったスキルレベルの高い職業に就いている傾向があることがわかる。

```{r}
piaac %>% 
  tbl_cross(educ, occupation, percent = "row")
```

先に確認したように、学歴と賃金の間には性別や年齢といった交絡要因が存在する（Z -> X, Z -> Y）。なので、あらかじめこれらを統制しておいたうえで、学歴による賃金の差が職業の違いによってどの程度説明されるのかというのをみる必要がある。

実際の分析結果は次のようになる。賃金については実額よりも対数を取った値のほうがよく使われるので、従属変数は対数賃金とする。また賃金を従属変数とする回帰分析の場合、年齢の2乗も考慮することが多いので、2乗項についても投入しよう。

```{r}
reg_res1 <- lm(data = piaac, logwage ~ educ + gender + age + I(age^2))
reg_res2 <- lm(data = piaac, logwage ~ educ + gender + age + I(age^2) + occupation)

modelsummary(list(reg_res1, reg_res2),
         stars = TRUE, 
         coef_rename = c("(Intercept)" = "切片",
                         "gender男性" = "男性（vs. 女性）",
                         "educ高校" = "高校（vs. 中学）",
                         "educ短大高専" = "短大高専（vs. 中学）",
                         "educ大学大学院" = "大学大学院（vs. 中学）",
                         "age" = "年齢",
                         "I(age^2)" = "年齢2乗",
                         "occupation専門職" = "専門職（vs. 管理職）",
                         "occupation技術職・准専門職" = "技術職・准専門職（vs. 管理職）",
                         "occupation事務補助" = "事務補助（vs. 管理職）",
                         "occupationサービス・販売" = "サービス・販売（vs. 管理職）",
                         "occupation農林漁業" = "農林漁業（vs. 管理職）",
                         "occupation技能工" = "技能工（vs. 管理職）",
                         "occupation設備・機械運転・組立" = "設備・機械運転・組立（vs. 管理職）",
                         "occupation単純作業" = "単純作業（vs. 管理職）"), 
         gof_omit = "R2 Adj.|AIC|BIC|Log.Lik.|F")
```

年齢と性別を統制したうえでの学歴の係数が、職業を考慮することによってどの程度変わるのかをみる。これをみると、Model 1と比べて、職業を一定としたModel 2では学歴の係数がかなり小さくなる。学歴が高いと賃金が高いという関連のかなりの部分が、職業分布の違いによって生じているようだということを、2つのモデルの学歴の係数の違いから読み取ることができる。


