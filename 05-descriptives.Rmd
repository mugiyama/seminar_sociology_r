# 1変数の集計 {#descriptives}

以下の記述はすでに`tidyverse`パッケージを読み込んでおり、また読み込んだデータを`piaac`というデータフレームに入れていることを前提とします。データフレームの名前は`piaac`である必要はありません。以下のようなコードを実行しています。

```{r, eval = FALSE}
library(tidyverse)
```

```{r}
piaac <- read_rds("data/piaac_sample.rds")
```

また、Macで`ggplot2`パッケージを使用し、グラフ中に日本語を使用する場合には、`library(tidyverse)`または`library(ggplot2)`を実行したうえで、たとえば以下のようなコードをあらかじめ実行しておく必要があります。

```{r, eval = FALSE}
theme_set(theme_grey(base_family = "HiraginoSans-W3"))
```

この資料で使用しているグラフについては以下のようにthemeを設定しています。

```{r, eval = FALSE}
theme_set(theme_bw(
  base_family = "HiraginoSans-W3",
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

Windowsユーザの方は上記コードから`base_family =`の行を除いたこちらのコードで同じような雰囲気になります：

```{r, eval = FALSE}
theme_set(theme_bw(
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

## 連続変数を集計する

### 要約統計量の計算
さまざまな変数を集計するときに最も基本的なコードが、`summarize()`である。たとえば、piaacというデータフレームに含まれている変数wageの平均値を求めたいとする。このようなときには、次のように記述する。

```{r}
piaac %>% 
  summarize(mean = mean(wage))
```

この命令は、「piaacというデータフレームのなかに入っている変数を集計してね、具体的には、平均値を求めてね、ちなみにその平均値にはmeanという名前をつけてね」ということを意味している。

集計する変数（この場合はwage）にNAが含まれていると計算ができず、結果もNAとなってしまう。NAが含まれる変数の平均値を計算するときには、あらかじめwageがNAの行を除外しておくとよい。詳しくは前章の[サンプルの選択](#handling_sample)を参照のこと。一時的にNAの行を除外して集計してみたい場合には、次のように書く。

```{r}
piaac %>% 
  filter(is.na(wage) == FALSE) %>% 
  summarize(mean = mean(wage))
```

平均値だけでなく、いろいろな統計量を計算できる。よく用いるものは以下のとおり。

+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| 関数                               | 意味                                                                                                              |
+====================================+===================================================================================================================+
| `mean(x)`                          | 平均値                                                                                                            |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| `sd(x)`                            | 標準偏差                                                                                                          |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| `max(x)`                           | 最大値                                                                                                            |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| `min(x)`                           | 最小値                                                                                                            |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| `quantile(x, 0.5)`                 | 分位数。0.5とした場合には50パーセンタイル点（中央値）を計算する。0（最小）から1（最大）まで任意の点を指定できる。 |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+
| `n()`                              | 行数を数える。                                                                                                    |
+------------------------------------+-------------------------------------------------------------------------------------------------------------------+

全部集計してみるとたとえば以下のような感じになる。

```{r}
piaac %>% 
  summarize(mean = mean(wage),
            sd = sd(wage),
            max = max(wage),
            min = min(wage),
            p25 = quantile(wage, 0.25),
            p50 = quantile(wage, 0.5),
            p75 = quantile(wage, 0.75),
            n = n())
```

いくつかの変数について最小値、第1四分位点、中央値、平均値、第3四分位点、最大値をまとめて表示したい場合、これらを一つひとつやっていくのはとても煩雑である。このような場合には、統計量を計算したい変数だけを`select()`で抽出し、そのうえで、`summary()`関数を使うとできる。たとえば、wage, age, healthの3つの変数についての統計量をまとめて見てみたい場合に次のようにする。

```{r}
piaac %>% 
  select(wage, age, health) %>% 
  summary()
```

### 分布の可視化：ヒストグラム

連続変数の場合にはたんに平均値や中央値だけを見るだけでなく、分布を見ることも重要だ。連続変数の分布をみるときには、ヒストグラムを使うのが有効である。百聞は一見に如かず。まずはヒストグラムをみてみよう。

```{r}
piaac %>% 
  ggplot(aes(x = wage)) + 
  geom_histogram()
```

このように、Rでグラフを作成したいときに活躍するのが`ggplot2`である。`ggplot2`は`tidyverse`パッケージを読み込むと合わせて読み込まれるため、別途`library(ggplot2)`で読み込む必要はない。

`ggplot2`の基本的な発想は、キャンバスに絵の具を重ね塗りしていくかのように、一つひとつ層を重ねていってグラフを作るというものである。具体的にみてみよう。先ほどのコードから3行目を削除した次の結果を確認してみよう。

```{r}
piaac %>% 
  ggplot(aes(x = wage))
```

`ggplot()`という部分が、グラフを書くための準備をしている箇所である。`aes()`のなかでは、x軸やy軸にそれぞれ何の変数を取るのかであったり、どのような色で分けるのか（後述）などを指定する。今の場合であれば、x軸にwageをとる、ということを指している。上記の命令だけだと、このようにx軸のみが表示された空白の座標が準備される。

`geom_histogram()`というのが、ヒストグラムを書くためのコードである。先ほどのコードに、`+`でつないで`geom_histogram()`というコードを追加すると、空白の座標にヒストグラムが描かれる。縦軸（count）は、その区間に何人の人が属しているかを示している。

```{r}
piaac %>% 
  ggplot(aes(x = wage)) + 
  geom_histogram()
```

`geom_histogram()`内でオプションを指定することで、ヒストグラムの見た目をさまざまに変更できる。たとえば、区間の区切りの個数（`bins`）を細かくしてみよう（デフォルトは`bins = 30`）。

```{r}
piaac %>% 
  ggplot(aes(x = wage)) + 
  geom_histogram(bins = 100)
```

以下、`+`でつないでいくことで、さらに層を重ねて、グラフの見た目を変更できる。たとえば、軸に名前をつけるコマンド`labs()`と、x軸の範囲を指定する`xlim()`を使って、より見やすいグラフを作ってみよう。

```{r}
piaac %>% 
  ggplot(aes(x = wage)) + 
  geom_histogram(bins = 100) + 
  labs(x = "賃金", y = "度数") + 
  xlim(0, 10000)
```

## カテゴリ変数の集計

### 度数の確認
カテゴリ変数の場合は平均値や標準偏差のような要約統計量を計算することはできない（意味がない）。最も基本的な集計は、各カテゴリにそれぞれ何人いるのかを確認することだ。`with(table())`を使うことで各カテゴリの人数（行数）をみることができる。

```{r}
piaac %>% 
  with(table(occupation))
```

人数だけでなく、各職業にどれくらいの割合の人が含まれているのかも重要だ。先ほどのコマンドに`prop.table()`を加えることで、各カテゴリに含まれる人が全体に占める割合を計算できる。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table()
```

小数点以下が多すぎて見にくいので、小数点第3位で丸めよう。先ほどのコマンドに`round(digits = 3)`を加えると、小数点第3位で丸めることができる。digitsのところの値が、小数点第○位の○の値に対応する。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table()  %>% 
  round(3)
```

この値はすべて足すと1になる。なので、この値を100倍すると百分率（%）としてよむことができる。

### 分布の可視化：棒グラフ

こうして集計した値を棒グラフにして表すと見やすいかもしれない。そのためにまず、先の集計表をデータフレーム形式に変換してみよう。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table() %>% 
  as.data.frame()
```

このように、1行が1つの職業を表し、Freqという列には先ほど計算した割合が入っているようなデータフレームに変換することができる。これを`ggplot()`に渡してやることで、棒グラフをつくることができる。棒グラフを作るときのコマンドは、`geom_col()`。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table() %>% 
  as.data.frame() %>% 
  ggplot(aes(x = occupation, y = Freq)) + 
  geom_col()
```

悪くないけれど、横軸のラベルがかぶってしまって、何を指しているのかいまいちわからなくなってしまっている。また、縦軸や横軸の名前は必ずしもわかりやすいものではないだろう。そこで、以下のようにコマンドを追加しよう。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table() %>% 
  as.data.frame() %>% 
  ggplot(aes(x = occupation, y = Freq)) + 
  geom_col() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # X軸を45度傾ける
  labs(x = "職業", y = "割合") # x軸とy軸に名前をつける
```

## 記述統計量の一覧表を作る

論文などで分析に使用する変数の記述統計量の一覧表を示していることがよくある。このような表を作ることで、読む側にとっては変数の分布を確認でき、その後の結果も読みやすくなる。こうした一覧表を作るために非常に便利なパッケージが`gtsummary`だ。まずはこれを読み込もう。

```{r, eval = FALSE}
libary(gtsummary)
```

次の5つの変数の記述統計量の一覧表を作りたいとしよう。`select()`を使って、こららの変数だけを残したデータフレームを作成する。

| 列名       | 型                 | 変数ラベル |
|------------|--------------------|------------|
| gender     | カテゴリ（factor） | 性別       |
| age        | 連続（numeric）    | 年齢       |
| educ       | カテゴリ（factor） | 最終学歴   |
| occupation | カテゴリ（factor） | 職業       |
| wage       | 連続（numeric）    | 賃金       |

```{r}
piaac_selected <- piaac %>% 
  select(gender, age, educ, occupation, wage)
```

この中には連続変数もカテゴリ変数もあり、またカテゴリの個数が2つのものもあればもっと多いものもあって複雑である。`gtsummary::tbl_summary()`は、変数の型がきちんとしていれば、それを読み取ってきれいな記述統計量の表を作ってくれる。

```{r}
piaac_selected %>% 
  tbl_summary()
```

これでもすでにかなりきれいな表になっているが、以下の2点で改善の余地がある。

1.  educやoccupationといった変数がそれぞれ何を示しているのか、自分以外の見る人にとっては必ずしも明らかではない。
2.  連続変数については中央値（50パーセンタイル点）、第1四分位数（25パーセンタイル点）、第3四分位数（75パーセンタイル点）が示されているが、平均値と標準偏差を載せることのほうが多いので、そちらを表記したい。
3. 左上のCharacteristicsというのがなんだか気になるので削除したい。

これらを1つずつ改善していこう。

### 変数にラベル（名前）をつける

```{r, eval = FALSE}
library(labelled)
```

```{r}
piaac_selected <- piaac_selected %>% 
  set_variable_labels(
    gender = "性別",
    age = "年齢",
    educ = "最終学歴",
    occupation = "職業",
    wage = "賃金"
    )
```

```{r}
piaac_selected %>% 
  tbl_summary()
```

### 連続変数は平均値・標準偏差を表示する

```{r}
piaac_selected %>% 
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"),
              digits = all_continuous() ~ 1)
```

### 左上のヘッダーの編集

以下のように`%>%`でつないで`modify_header()`を指定すると、左上のヘッダー部分を編集できる。

```{r}
piaac_selected %>% 
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"),
              digits = all_continuous() ~ 1) %>% 
  modify_header(label ~ "")
```

`modify_header(label ~ "")`の`""`の部分に好きな文字列を入れることができる。上記のように何も入れなければ、空欄になる。何か入れるとしたら、日本語なら"変数"、英語なら"Variables"かな。

### グループ別の記述統計量の一覧表

何らかの属性などでサンプルを分けて比較分析する場合には、属性ごとの記述統計量を示すとよい。これも、`tbl_summary()`のなかでオプションを指定することで簡単に実行することができる。

```{r}
piaac_selected %>% 
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"),
              by = gender,
              digits = all_continuous() ~ 1) %>% 
  modify_header(label ~ "")
```

## 結果をファイルに書き出す

### 結果を入れるためのフォルダを作る

上記ではいろいろなグラフを作ったり、要約統計量を計算するためのコマンドを紹介してきた。RStudio上で見る分にはこれで十分だが、実際にこれらを論文にまとめていく段階では、結果をwordに貼り付けたりする必要がある。ここではそうした方法を紹介する。

3章で、[データを置くためのフォルダを作成](#import_dir)しておくとよいということを紹介した。分析結果を保存しておくためのフォルダというのも別途あると整理整頓ができて便利である。ここでは、「results」という分析結果を保存しておくためのフォルダを作ろう。右クリックで「新規フォルダを作成」するか、以下のコードを実行する。

```{r, eval = FALSE}
dir.create("results")
```

### ggplotで作成した図を書き出す

ggplotで作成した図を保存する方法は以下のとおりである。日本語フォントを含んでいるかどうか、および、出力形式によってどのようなコマンドを実行するかが変わってくるので、注意が必要。

#### 日本語フォントを含まない図の場合

```{r, echo = FALSE}
theme_set(theme_bw(
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

```{r}
piaac %>% 
  ggplot(aes(x = wage)) + 
  geom_histogram() + 
  xlim(0, 10000)
```

ここでは図を保存するときの形式として、pdfファイルとpngファイルについて説明する。

pdfはベクター形式といわれていて、拡大しても画質が荒くならない。どんなに大きくしたり小さくしたりしてもつねにきれいなグラフが保持されるというメリットがあるが、Wordファイルに貼り付けられなかったりすることもある（たしかWindowsだとWordにpdfを貼り付けられない気がする？）。

pngはラスタ形式と言われていて、（写真みたいに）拡大すると画質が荒くなってしまう。ただ、よっぽど拡大しない限りはそれなりにきれいな図にすることができるので、これでも事足りる場面は多い。この方法は、WindowsでもMacでも実行できるはず。

書き出したい図が右下のplotのウィンドウに表示された状態で`ggsave()`を使って保存することができる。

```{r}
ggsave("results/histogram.pdf") # png形式
ggsave("results/histogram.png") # png形式
```

サイズをとくに指定しない場合には、plotの画面に表示されている縮尺で結果が保存される。これだとあまりplotのウィンドウの大きさによって出力結果が変わってしまうので、次のように幅と高さを指定するとよい。

```{r}
ggsave("results/histogram.pdf", width = 5, height = 4)
```

自分はたいていwidthを5、heightを4に設定している。

#### 日本語フォントを含む図の場合

```{r, echo = FALSE}
theme_set(theme_bw(
  base_family = "HiraginoSans-W3",
  base_size = 11,
  base_rect_size = 0.2,
  base_line_size = 0.2
))
```

続いて、日本語フォントを含む図を保存してみよう。

```{r}
piaac %>% 
  with(table(occupation)) %>% 
  prop.table() %>% 
  as.data.frame() %>% 
  ggplot(aes(x = occupation, y = Freq)) + 
  geom_col() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # X軸を45度傾ける
  labs(x = "職業", y = "割合") # x軸とy軸に名前をつける
```

png形式の場合は今までと同じ方法で文字化けせずに保存できる。

```{r}
ggsave("results/bar_graph.png", width = 5, height = 4) # png形式
```

pdfの場合にはひとくふう必要となる。まず、保存したいグラフをオブジェクトに入れてやる。

```{r}
g <- piaac %>% 
  with(table(occupation)) %>% 
  prop.table() %>% 
  as.data.frame() %>% 
  ggplot(aes(x = occupation, y = Freq)) + 
  geom_col() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # X軸を45度傾ける
  labs(x = "職業", y = "割合") # x軸とy軸に名前をつける
```

そのうえで、Windowsの場合は以下のコマンド：

```{r, eval = FALSE}
pdf(file = "results/bar_graph.pdf", family = "Japan1GothicBBB", width = 5, height = 4) 
g
dev.off() 
```

Macの場合は以下のコマンドで保存する：

```{r}
quartz(file = "results/bar_graph.pdf", type = "pdf", family = "sans",  width = 5, height = 4) 
g
dev.off() 
```

### 記述統計の一覧表をwordに書き出す

`gtsummary::tbl_summary()`で作成した記述統計の表はword形式で書き出すことができる。その際に用いるパッケージが`flextable`である。まずはこのパッケージを読み込んでおく。

```{r, eval = FALSE}
library(flextable)
```

先ほど作成したグループ別の記述統計量の表をwordファイルに書き出したいときには、以下のように%>%演算子でつないで、`as_flex_table() %>% save_as_docs(path = "xxx.docx")`というコマンドを追加する。

```{r}
piaac_selected %>% 
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"),
              by = gender,
              digits = all_continuous() ~ 1) %>% 
  modify_header(label ~ "") %>% 
  as_flex_table() %>% 
  save_as_docx(path = "results/summary.docx")
```

